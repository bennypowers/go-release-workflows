name: Build Binaries

on:
  workflow_call:
    inputs:
      binary-name:
        description: 'Name of the binary (used for output path validation)'
        required: true
        type: string
      platforms:
        description: 'JSON array of platforms to build'
        required: false
        type: string
        default: '["linux-x64", "linux-arm64", "darwin-x64", "darwin-arm64", "win32-x64", "win32-arm64"]'
      release-tag:
        description: 'GitHub release tag to upload to (empty = artifacts only)'
        required: false
        type: string
        default: ''
    outputs:
      artifacts:
        description: 'JSON array of built artifacts'
        value: ${{ jobs.aggregate.outputs.artifacts }}

jobs:
  validate:
    name: Validate Makefile Contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: bennypowers/go-release-workflows/.github/actions/validate-makefile@main
        with:
          platforms: ${{ inputs.platforms }}
          binary-name: ${{ inputs.binary-name }}

  build-linux:
    name: Build Linux
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJSON(inputs.platforms) }}
        exclude:
          - platform: darwin-x64
          - platform: darwin-arm64
          - platform: win32-x64
          - platform: win32-arm64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install cross-compilers
        if: matrix.platform == 'linux-arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build ${{ matrix.platform }}
        run: make ${{ matrix.platform }}

      - uses: bennypowers/go-release-workflows/.github/actions/validate-output@main
        with:
          binary-name: ${{ inputs.binary-name }}
          platform: ${{ matrix.platform }}

      - name: Upload to release
        if: inputs.release-tag != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload '${{ inputs.release-tag }}' \
            'dist/bin/${{ inputs.binary-name }}-${{ matrix.platform }}' \
            --clobber

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.binary-name }}-${{ matrix.platform }}
          path: dist/bin/${{ inputs.binary-name }}-${{ matrix.platform }}
          retention-days: 7

  build-darwin:
    name: Build macOS
    needs: validate
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJSON(inputs.platforms) }}
        exclude:
          - platform: linux-x64
          - platform: linux-arm64
          - platform: win32-x64
          - platform: win32-arm64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build ${{ matrix.platform }}
        run: make ${{ matrix.platform }}

      - uses: bennypowers/go-release-workflows/.github/actions/validate-output@main
        with:
          binary-name: ${{ inputs.binary-name }}
          platform: ${{ matrix.platform }}

      - name: Upload to release
        if: inputs.release-tag != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload '${{ inputs.release-tag }}' \
            'dist/bin/${{ inputs.binary-name }}-${{ matrix.platform }}' \
            --clobber

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.binary-name }}-${{ matrix.platform }}
          path: dist/bin/${{ inputs.binary-name }}-${{ matrix.platform }}
          retention-days: 7

  build-windows:
    name: Build Windows
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJSON(inputs.platforms) }}
        exclude:
          - platform: linux-x64
          - platform: linux-arm64
          - platform: darwin-x64
          - platform: darwin-arm64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - uses: bennypowers/go-release-workflows/.github/actions/setup-windows-build@main

      - name: Build ${{ matrix.platform }}
        run: make ${{ matrix.platform }}

      - uses: bennypowers/go-release-workflows/.github/actions/validate-output@main
        with:
          binary-name: ${{ inputs.binary-name }}
          platform: ${{ matrix.platform }}
          windows: 'true'

      - name: Upload to release
        if: inputs.release-tag != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload '${{ inputs.release-tag }}' \
            'dist/bin/${{ inputs.binary-name }}-${{ matrix.platform }}.exe' \
            --clobber

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.binary-name }}-${{ matrix.platform }}
          path: dist/bin/${{ inputs.binary-name }}-${{ matrix.platform }}.exe
          retention-days: 7

  aggregate:
    name: Aggregate Results
    needs:
      - build-linux
      - build-darwin
      - build-windows
    if: always()
    runs-on: ubuntu-latest
    outputs:
      artifacts: ${{ steps.collect.outputs.artifacts }}
    steps:
      - uses: bennypowers/go-release-workflows/.github/actions/collect-artifacts@main
        id: collect
        with:
          platforms: ${{ inputs.platforms }}
          binary-name: ${{ inputs.binary-name }}

      - name: Get artifact download URLs
        if: github.event_name == 'pull_request'
        id: artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --jq '.artifacts[] | "\(.name)=\(.id)"')
          for line in $ARTIFACTS; do
            name="${line%%=*}"
            id="${line#*=}"
            # Convert artifact name to env-safe format (replace - with _)
            safe_name=$(echo "$name" | tr '-' '_')
            echo "${safe_name}_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${id}" >> "$GITHUB_OUTPUT"
          done

      - name: Find existing PR comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Build Artifacts'

      - name: Post or update PR comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Build Artifacts

            | OS | x64 | arm64 |
            |----|-----|-------|
            | Linux | ${{ contains(needs.build-linux.result, 'success') && format('✅ [{0}-linux-x64]({1})', inputs.binary-name, steps.artifacts.outputs[format('{0}_linux_x64_url', inputs.binary-name)]) || '❌' }} | ${{ contains(needs.build-linux.result, 'success') && format('✅ [{0}-linux-arm64]({1})', inputs.binary-name, steps.artifacts.outputs[format('{0}_linux_arm64_url', inputs.binary-name)]) || '❌' }} |
            | macOS | ${{ contains(needs.build-darwin.result, 'success') && format('✅ [{0}-darwin-x64]({1})', inputs.binary-name, steps.artifacts.outputs[format('{0}_darwin_x64_url', inputs.binary-name)]) || '❌' }} | ${{ contains(needs.build-darwin.result, 'success') && format('✅ [{0}-darwin-arm64]({1})', inputs.binary-name, steps.artifacts.outputs[format('{0}_darwin_arm64_url', inputs.binary-name)]) || '❌' }} |
            | Windows | ${{ contains(needs.build-windows.result, 'success') && format('✅ [{0}-win32-x64]({1})', inputs.binary-name, steps.artifacts.outputs[format('{0}_win32_x64_url', inputs.binary-name)]) || '❌' }} | ${{ contains(needs.build-windows.result, 'success') && format('✅ [{0}-win32-arm64]({1})', inputs.binary-name, steps.artifacts.outputs[format('{0}_win32_arm64_url', inputs.binary-name)]) || '❌' }} |

            *Built from ${{ github.sha }} @ ${{ github.event.pull_request.head.ref }}*
          edit-mode: replace
